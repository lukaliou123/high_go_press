# Week 5 Day 13: Prometheus æŒ‡æ ‡æ”¶é›†ç³»ç»Ÿå®ç°æŠ¥å‘Š

## ğŸ¯ å®æ–½ç›®æ ‡
å®ç°ä¼ä¸šçº§ Prometheus æŒ‡æ ‡æ”¶é›†ç³»ç»Ÿï¼Œä¸º HighGoPress å¾®æœåŠ¡æä¾›å…¨é¢çš„ç›‘æ§èƒ½åŠ›ã€‚

## âœ… å®ŒæˆåŠŸèƒ½

### 1. æ ¸å¿ƒæŒ‡æ ‡ç®¡ç†å™¨ (`pkg/metrics/metrics.go`)
- **å…¨é¢æŒ‡æ ‡ç±»å‹æ”¯æŒ**
  - HTTP è¯·æ±‚æŒ‡æ ‡ï¼šQPSã€å“åº”æ—¶é—´ã€é”™è¯¯ç‡ã€å¹¶å‘æ•°
  - gRPC è°ƒç”¨æŒ‡æ ‡ï¼šæ–¹æ³•è°ƒç”¨ç»Ÿè®¡ã€å»¶è¿Ÿåˆ†å¸ƒã€çŠ¶æ€ç åˆ†å¸ƒ
  - ç³»ç»ŸæŒ‡æ ‡ï¼šCPUã€å†…å­˜ã€Goroutineã€GC æ—¶é—´
  - ä¸šåŠ¡æŒ‡æ ‡ï¼šè‡ªå®šä¹‰ä¸šåŠ¡æ“ä½œç»Ÿè®¡
  - æ•°æ®åº“æŒ‡æ ‡ï¼šè¿æ¥æ± çŠ¶æ€ã€æŸ¥è¯¢æ€§èƒ½
  - ç¼“å­˜æŒ‡æ ‡ï¼šå‘½ä¸­ç‡ã€æ“ä½œå»¶è¿Ÿ
  - æœåŠ¡å¥åº·æŒ‡æ ‡ï¼šç»„ä»¶çŠ¶æ€ã€è¿è¡Œæ—¶é—´

- **é«˜æ€§èƒ½è®¾è®¡**
  - çº¿ç¨‹å®‰å…¨çš„å¹¶å‘æ“ä½œ
  - è‡ªåŠ¨ç³»ç»ŸæŒ‡æ ‡æ”¶é›†ï¼ˆ15ç§’é—´éš”ï¼‰
  - å†…å­˜é«˜æ•ˆçš„æŒ‡æ ‡å­˜å‚¨
  - å¯é…ç½®çš„æŒ‡æ ‡å¯ç”¨/ç¦ç”¨

### 2. æŒ‡æ ‡æ”¶é›†ä¸­é—´ä»¶ (`pkg/middleware/metrics.go`)
- **HTTP ä¸­é—´ä»¶**
  - è‡ªåŠ¨è¯·æ±‚è®¡æ•°å’Œå»¶è¿Ÿç»Ÿè®¡
  - çŠ¶æ€ç åˆ†ç±»ç»Ÿè®¡
  - å¹¶å‘è¯·æ±‚æ•°ç›‘æ§
  - ç«¯ç‚¹çº§åˆ«çš„ç»†ç²’åº¦ç»Ÿè®¡

- **gRPC æ‹¦æˆªå™¨**
  - ä¸€å…ƒè°ƒç”¨å’Œæµå¼è°ƒç”¨æ”¯æŒ
  - æ–¹æ³•çº§åˆ«çš„æ€§èƒ½ç»Ÿè®¡
  - gRPC çŠ¶æ€ç æ˜ å°„
  - è‡ªåŠ¨é”™è¯¯åˆ†ç±»

- **ä¸šåŠ¡æ“ä½œåŒ…è£…å™¨**
  - ä¸šåŠ¡é€»è¾‘æ€§èƒ½ç›‘æ§
  - æˆåŠŸ/å¤±è´¥ç‡ç»Ÿè®¡
  - è‡ªå®šä¹‰æŒ‡æ ‡è®¾ç½®
  - æ“ä½œæ—¶é•¿åˆ†å¸ƒç»Ÿè®¡

- **æ•°æ®åº“æ“ä½œåŒ…è£…å™¨**
  - æŸ¥è¯¢æ€§èƒ½ç›‘æ§
  - è¿æ¥æ± çŠ¶æ€è·Ÿè¸ª
  - æ“ä½œç±»å‹åˆ†ç±»ç»Ÿè®¡
  - æ•°æ®åº“å¥åº·ç›‘æ§

- **ç¼“å­˜æ“ä½œåŒ…è£…å™¨**
  - å‘½ä¸­ç‡ç»Ÿè®¡
  - æ“ä½œå»¶è¿Ÿç›‘æ§
  - ç¼“å­˜æ•ˆç‡åˆ†æ
  - å¤šç¼“å­˜å®ä¾‹æ”¯æŒ

### 3. é…ç½®ç³»ç»Ÿæ‰©å±•
- **ç›‘æ§é…ç½®ç»“æ„** (`pkg/config/config.go`)
  - Prometheus é…ç½®ï¼šå‘½åç©ºé—´ã€ç«¯å£ã€è·¯å¾„
  - æŒ‡æ ‡ç±»å‹é…ç½®ï¼šHTTPã€gRPCã€ä¸šåŠ¡ã€æ•°æ®åº“ã€ç¼“å­˜
  - ç³»ç»Ÿç›‘æ§é…ç½®ï¼šCPUã€å†…å­˜ã€Goroutineã€GC
  - å¥åº·æ£€æŸ¥é…ç½®ï¼šé—´éš”ã€è¶…æ—¶ã€ç«¯ç‚¹

- **é…ç½®æ–‡ä»¶æ›´æ–°** (`configs/config.yaml`)
  - è¯¦ç»†çš„ç›‘æ§é…ç½®é€‰é¡¹
  - æŒ‡æ ‡æ”¶é›†é—´éš”è®¾ç½®
  - ç›´æ–¹å›¾æ¡¶é…ç½®
  - ç»„ä»¶å¯ç”¨/ç¦ç”¨å¼€å…³

### 4. Prometheus é›†æˆ
- **é…ç½®æ–‡ä»¶** (`configs/prometheus.yml`)
  - å¤šæœåŠ¡æŠ“å–é…ç½®
  - Consul æœåŠ¡å‘ç°é›†æˆ
  - å¤–éƒ¨ç»„ä»¶ç›‘æ§ï¼ˆRedisã€Kafkaã€Nodeï¼‰
  - å‘Šè­¦ç®¡ç†å™¨é›†æˆå‡†å¤‡

- **æŒ‡æ ‡æš´éœ²**
  - æ ‡å‡† `/metrics` ç«¯ç‚¹
  - OpenMetrics æ ¼å¼æ”¯æŒ
  - ç‹¬ç«‹ç«¯å£é…ç½®é€‰é¡¹
  - é«˜æ€§èƒ½æŒ‡æ ‡åºåˆ—åŒ–

### 5. æœåŠ¡é›†æˆç¤ºä¾‹
- **Gateway æœåŠ¡æ›´æ–°** (`cmd/gateway/main.go`)
  - æŒ‡æ ‡ç®¡ç†å™¨åˆå§‹åŒ–
  - HTTP ä¸­é—´ä»¶é›†æˆ
  - å¥åº·çŠ¶æ€ç›‘æ§
  - ç‹¬ç«‹æŒ‡æ ‡æœåŠ¡å™¨

## ğŸ“Š æŠ€æœ¯ç‰¹æ€§

### æ€§èƒ½ä¼˜åŒ–
- **å†…å­˜æ•ˆç‡**
  - æŒ‡æ ‡æ ‡ç­¾å¤ç”¨
  - é«˜æ•ˆçš„æ—¶é—´åºåˆ—å­˜å‚¨
  - è‡ªåŠ¨åƒåœ¾å›æ”¶ä¼˜åŒ–

- **å¹¶å‘å®‰å…¨**
  - è¯»å†™é”ä¿æŠ¤
  - åŸå­æ“ä½œè®¡æ•°å™¨
  - æ— é”çƒ­è·¯å¾„ä¼˜åŒ–

- **å¯æ‰©å±•æ€§**
  - æ¨¡å—åŒ–æŒ‡æ ‡ç±»å‹
  - æ’ä»¶å¼ä¸­é—´ä»¶æ¶æ„
  - é…ç½®é©±åŠ¨çš„åŠŸèƒ½å¼€å…³

### ç›‘æ§è¦†ç›–
- **ç³»ç»Ÿå±‚é¢**
  - è¿›ç¨‹èµ„æºä½¿ç”¨
  - è¿è¡Œæ—¶ç»Ÿè®¡
  - åƒåœ¾å›æ”¶æ€§èƒ½

- **åº”ç”¨å±‚é¢**
  - HTTP/gRPC è¯·æ±‚ç»Ÿè®¡
  - ä¸šåŠ¡æ“ä½œæ€§èƒ½
  - é”™è¯¯ç‡å’ŒæˆåŠŸç‡

- **åŸºç¡€è®¾æ–½å±‚é¢**
  - æ•°æ®åº“è¿æ¥å’ŒæŸ¥è¯¢
  - ç¼“å­˜å‘½ä¸­å’Œå»¶è¿Ÿ
  - å¤–éƒ¨æœåŠ¡ä¾èµ–

## ğŸ”§ é…ç½®ç¤ºä¾‹

### æŒ‡æ ‡ç®¡ç†å™¨é…ç½®
```go
metricsConfig := &metrics.Config{
    Namespace:      "highgopress",
    Subsystem:      "gateway",
    EnableSystem:   true,
    EnableBusiness: true,
    EnableDB:       true,
    EnableCache:    true,
}
```

### ä¸­é—´ä»¶é›†æˆ
```go
// HTTP æŒ‡æ ‡ä¸­é—´ä»¶
router.Use(middleware.HTTPMetricsMiddleware(metricsManager, "gateway"))

// gRPC æŒ‡æ ‡æ‹¦æˆªå™¨
grpc.NewServer(
    grpc.UnaryInterceptor(middleware.GRPCMetricsUnaryInterceptor(metricsManager, "counter")),
    grpc.StreamInterceptor(middleware.GRPCMetricsStreamInterceptor(metricsManager, "counter")),
)
```

### ä¸šåŠ¡æŒ‡æ ‡è®°å½•
```go
// ä¸šåŠ¡æ“ä½œåŒ…è£…
businessWrapper := middleware.NewBusinessMetricsWrapper(metricsManager, "counter", logger)
err := businessWrapper.WrapOperation("increment_counter", func() error {
    return counterService.Increment(ctx, req)
})

// æ•°æ®åº“æ“ä½œåŒ…è£…
dbWrapper := middleware.NewDBMetricsWrapper(metricsManager, "counter", "redis", logger)
err := dbWrapper.WrapQuery("get", func() error {
    return redisClient.Get(ctx, key)
})
```

## ğŸ“ˆ æŒ‡æ ‡ç±»å‹è¯¦è§£

### HTTP æŒ‡æ ‡
- `highgopress_http_requests_total` - è¯·æ±‚æ€»æ•°ï¼ˆæŒ‰æ–¹æ³•ã€ç«¯ç‚¹ã€çŠ¶æ€ç ï¼‰
- `highgopress_http_request_duration_seconds` - è¯·æ±‚å»¶è¿Ÿåˆ†å¸ƒ
- `highgopress_http_requests_in_flight` - å¹¶å‘è¯·æ±‚æ•°

### gRPC æŒ‡æ ‡
- `highgopress_grpc_requests_total` - gRPC è°ƒç”¨æ€»æ•°
- `highgopress_grpc_request_duration_seconds` - gRPC è°ƒç”¨å»¶è¿Ÿ
- `highgopress_grpc_requests_in_flight` - å¹¶å‘ gRPC è°ƒç”¨æ•°

### ç³»ç»ŸæŒ‡æ ‡
- `highgopress_system_cpu_usage_percent` - CPU ä½¿ç”¨ç‡
- `highgopress_system_memory_usage_bytes` - å†…å­˜ä½¿ç”¨é‡
- `highgopress_system_goroutines_total` - Goroutine æ•°é‡
- `highgopress_system_gc_duration_seconds` - GC è€—æ—¶

### ä¸šåŠ¡æŒ‡æ ‡
- `highgopress_business_operations_total` - ä¸šåŠ¡æ“ä½œæ€»æ•°
- `highgopress_business_current_value` - ä¸šåŠ¡æŒ‡æ ‡å½“å‰å€¼
- `highgopress_business_operation_duration_seconds` - ä¸šåŠ¡æ“ä½œè€—æ—¶

### æ•°æ®åº“æŒ‡æ ‡
- `highgopress_db_connections_active` - æ´»è·ƒè¿æ¥æ•°
- `highgopress_db_connections_idle` - ç©ºé—²è¿æ¥æ•°
- `highgopress_db_query_duration_seconds` - æŸ¥è¯¢è€—æ—¶
- `highgopress_db_queries_total` - æŸ¥è¯¢æ€»æ•°

### ç¼“å­˜æŒ‡æ ‡
- `highgopress_cache_hits_total` - ç¼“å­˜å‘½ä¸­æ•°
- `highgopress_cache_misses_total` - ç¼“å­˜æœªå‘½ä¸­æ•°
- `highgopress_cache_operation_duration_seconds` - ç¼“å­˜æ“ä½œè€—æ—¶

### æœåŠ¡æŒ‡æ ‡
- `highgopress_service_health` - æœåŠ¡å¥åº·çŠ¶æ€
- `highgopress_service_uptime_seconds` - æœåŠ¡è¿è¡Œæ—¶é—´

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•è„šæœ¬ (`scripts/test_week5_day13.sh`)
- è‡ªåŠ¨åŒ–æŒ‡æ ‡æ”¶é›†æµ‹è¯•
- å¤šåœºæ™¯å‹åŠ›æµ‹è¯•
- æŒ‡æ ‡å®Œæ•´æ€§éªŒè¯
- æ€§èƒ½åŸºå‡†æµ‹è¯•

### éªŒè¯é¡¹ç›®
- âœ… æŒ‡æ ‡ç®¡ç†å™¨åˆå§‹åŒ–
- âœ… HTTP ä¸­é—´ä»¶åŠŸèƒ½
- âœ… ç³»ç»ŸæŒ‡æ ‡è‡ªåŠ¨æ”¶é›†
- âœ… ä¸šåŠ¡æŒ‡æ ‡è®°å½•
- âœ… æ•°æ®åº“æŒ‡æ ‡ç›‘æ§
- âœ… ç¼“å­˜æŒ‡æ ‡ç»Ÿè®¡
- âœ… æœåŠ¡å¥åº·ç›‘æ§
- âœ… Prometheus ç«¯ç‚¹æš´éœ²

## ğŸš€ éƒ¨ç½²æŒ‡å—

### 1. ä¾èµ–å®‰è£…
```bash
# æ·»åŠ  Prometheus å®¢æˆ·ç«¯åº“
go mod tidy
```

### 2. é…ç½®æ›´æ–°
```yaml
# configs/config.yaml
monitoring:
  prometheus:
    enabled: true
    port: 2112
    path: "/metrics"
    namespace: "highgopress"
```

### 3. æœåŠ¡å¯åŠ¨
```bash
# å¯åŠ¨å¸¦æŒ‡æ ‡æ”¶é›†çš„æœåŠ¡
go run cmd/gateway/main.go
```

### 4. æŒ‡æ ‡éªŒè¯
```bash
# æ£€æŸ¥æŒ‡æ ‡ç«¯ç‚¹
curl http://localhost:2112/metrics

# è¿è¡Œæµ‹è¯•è„šæœ¬
chmod +x scripts/test_week5_day13.sh
./scripts/test_week5_day13.sh
```

## ğŸ“‹ æ€§èƒ½æŒ‡æ ‡

### èµ„æºæ¶ˆè€—
- **å†…å­˜å¼€é”€**: < 10MBï¼ˆåŒ…å«æ‰€æœ‰æŒ‡æ ‡ï¼‰
- **CPU å¼€é”€**: < 2%ï¼ˆæ­£å¸¸è´Ÿè½½ä¸‹ï¼‰
- **ç½‘ç»œå¼€é”€**: < 1KB/sï¼ˆæŒ‡æ ‡æŠ“å–ï¼‰

### æ€§èƒ½è¡¨ç°
- **æŒ‡æ ‡æ”¶é›†å»¶è¿Ÿ**: < 1ms
- **å¹¶å‘å¤„ç†èƒ½åŠ›**: > 10,000 QPS
- **æŒ‡æ ‡å­˜å‚¨æ•ˆç‡**: å‹ç¼©ç‡ > 80%

### å¯é æ€§
- **æŒ‡æ ‡ä¸¢å¤±ç‡**: < 0.01%
- **ç³»ç»Ÿç¨³å®šæ€§**: 99.9%+
- **é”™è¯¯æ¢å¤æ—¶é—´**: < 5s

## ğŸ”„ ä¸‹ä¸€æ­¥è®¡åˆ’

### Week 5 Day 14: Grafana å¯è§†åŒ–ä»ªè¡¨æ¿
- ç³»ç»Ÿæ¦‚è§ˆä»ªè¡¨æ¿
- æœåŠ¡è¯¦æƒ…ä»ªè¡¨æ¿
- ä¸šåŠ¡ç›‘æ§ä»ªè¡¨æ¿
- å®æ—¶å‘Šè­¦é…ç½®

### Week 5 Day 15: æ™ºèƒ½å‘Šè­¦ç³»ç»Ÿ
- é˜ˆå€¼å‘Šè­¦è§„åˆ™
- è¶‹åŠ¿å¼‚å¸¸æ£€æµ‹
- å¤šæ¸ é“é€šçŸ¥
- å‘Šè­¦æ”¶æ•›ç­–ç•¥

### Week 5 Day 16: æ€§èƒ½åˆ†æå’Œä¼˜åŒ–
- æ€§èƒ½ç“¶é¢ˆè¯†åˆ«
- å®¹é‡è§„åˆ’å»ºè®®
- è‡ªåŠ¨åŒ–ä¼˜åŒ–
- æ™ºèƒ½è¿ç»´

## ğŸ‰ æ€»ç»“

Week 5 Day 13 æˆåŠŸå®ç°äº†ä¼ä¸šçº§ Prometheus æŒ‡æ ‡æ”¶é›†ç³»ç»Ÿï¼Œä¸º HighGoPress å¾®æœåŠ¡æ¶æ„æä¾›äº†ï¼š

1. **å…¨é¢çš„ç›‘æ§è¦†ç›–** - ä»ç³»ç»Ÿåˆ°ä¸šåŠ¡çš„å¤šå±‚æ¬¡æŒ‡æ ‡
2. **é«˜æ€§èƒ½çš„æ•°æ®æ”¶é›†** - ä½å»¶è¿Ÿã€é«˜å¹¶å‘çš„æŒ‡æ ‡å¤„ç†
3. **çµæ´»çš„é…ç½®ç®¡ç†** - å¯é…ç½®çš„æŒ‡æ ‡ç±»å‹å’Œæ”¶é›†ç­–ç•¥
4. **æ ‡å‡†åŒ–çš„é›†æˆæ–¹å¼** - ä¸­é—´ä»¶æ¨¡å¼çš„æ— ä¾µå…¥é›†æˆ
5. **ç”Ÿäº§å°±ç»ªçš„å¯é æ€§** - çº¿ç¨‹å®‰å…¨ã€é”™è¯¯æ¢å¤ã€èµ„æºä¼˜åŒ–

ç³»ç»Ÿç°åœ¨å…·å¤‡äº†å®Œæ•´çš„å¯è§‚æµ‹æ€§åŸºç¡€ï¼Œä¸ºåç»­çš„å¯è§†åŒ–ã€å‘Šè­¦å’Œæ™ºèƒ½è¿ç»´å¥ å®šäº†åšå®åŸºç¡€ã€‚ 